<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>VibeZone Oda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body {
            background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
        }

        /* Chat container - sabit y√ºkseklik ve scroll */
        #chatMessages {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Scrollbar stillemesi */
        #chatMessages::-webkit-scrollbar {
            width: 6px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 3px;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Video grid (flex ile zaten y√ºkseklik alƒ±yor, ekstra max-height yok) */
        #videoGrid {
            overflow-y: auto;
        }

        /* Konu≈üma g√∂stergesi */
        .tile-speaking {
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.9),
                        0 0 18px rgba(52, 211, 153, 0.6);
        }

        /* Spotlight: ekran payla≈üƒ±mƒ± yapan */
        .tile-spotlight {
            order: -1;
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.9),
                        0 0 28px rgba(129, 140, 248, 0.75);
        }
        /* Daha k√º√ß√ºk spotlight */
        @media (min-width: 640px) {
            /* sm: 2 kolon ‚Üí spotlight 2 kolon */
            .tile-spotlight {
                grid-column: 1 / span 2;
            }
        }
        @media (min-width: 1024px) {
            /* lg: 3 kolon ‚Üí spotlight 2 kolon */
            .tile-spotlight {
                grid-column: 1 / span 2;
            }
        }

        /* Emoji tepkisi animasyonu */
        @keyframes reaction-pop {
            0% {
                transform: translate(-50%, -30%) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -80%) scale(1);
                opacity: 0;
            }
        }
        .animate-reaction {
            animation: reaction-pop 1.1s ease-out forwards;
        }

        /* Mobilde sidePanel'i tam ekran drawer gibi g√∂ster */
        @media (max-width: 1023px) {
            #sidePanel.mobile-open {
                position: fixed;
                inset: 0;
                width: 100%;
                max-width: 100%;
                z-index: 40;
                background-color: rgba(15, 23, 42, 0.98);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-100 overflow-hidden">
    <!-- Header -->
    <header class="flex-shrink-0 w-full bg-slate-950/95 border-b border-slate-800">
        <div class="max-w-6xl mx-auto px-3 py-1.5 sm:px-4 sm:py-2.5 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-gradient-to-tr from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center">
                    <i class="fa-solid fa-headset text-lg"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-lg">VibeZone</span>
                        <span id="roomCodeBadge"
                              class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-xs font-mono">
                            #<span id="roomCodeText">------</span>
                        </span>
                        <button id="copyCodeBtn"
                                class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-xs hover:bg-slate-800">
                            <i class="fa-solid fa-copy"></i> Kopyala
                        </button>
                    </div>
                    <p class="text-xs text-slate-400">
                        Sen: <span id="currentUserName" class="text-slate-200"></span>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-xs">
                <div id="connectionStatus" class="flex items-center gap-2">
                    <span class="flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-900/50 border border-yellow-700 text-yellow-400">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Baƒülanƒ±yor...</span>
                    </span>
                </div>
                <button id="btnLockRoom"
                        class="hidden px-2 py-1 rounded-full bg-slate-900 border border-slate-700 hover:bg-slate-800 text-[11px] flex items-center gap-1">
                    <i class="fa-solid fa-lock-open"></i>
                    <span class="hidden sm:inline">Odayƒ± kilitle</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Video Grid -->
        <section class="flex-1 flex flex-col bg-slate-900/80 overflow-hidden">
            <div id="videoGrid"
                 class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4 p-2 sm:p-4 overflow-y-auto">
                <!-- Local Video -->
                <div id="localTile"
                     class="relative rounded-2xl overflow-hidden bg-slate-950 border border-slate-800 aspect-video">
                    <!-- muted: ekran sesi kendi kulaƒüƒ±na d√∂nmesin -->
                    <video id="localVideo" autoplay playsinline muted
                           class="w-full h-full object-cover bg-black"></video>
                    <div class="absolute top-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1">
                        <span id="localStatusDot" class="h-2 w-2 rounded-full bg-yellow-400"></span>
                        <span>Sen</span>
                    </div>
                    <div class="absolute bottom-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1">
                        <i id="localMicIcon" class="fa-solid fa-microphone text-emerald-400"></i>
                        <span id="selfNameTag">Kullanƒ±cƒ±</span>
                    </div>
                    <!-- Kamera kapalƒ±yken g√∂sterilecek -->
                    <div id="localCamOff"
                         class="absolute inset-0 bg-slate-900 flex items-center justify-center hidden">
                        <div class="text-center">
                            <i class="fa-solid fa-video-slash text-4xl text-slate-600 mb-2"></i>
                            <p class="text-sm text-slate-500">Kamera kapalƒ±</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Medya izni uyarƒ±sƒ± -->
            <div id="mediaPermissionWarning"
                 class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-md text-center">
                    <i class="fa-solid fa-video text-5xl text-indigo-400 mb-4"></i>
                    <h2 class="text-xl font-semibold mb-2">Mikrofon (ve varsa kamera) izni gerekli</h2>
                    <p class="text-sm text-slate-400 mb-4">
                        Toplantƒ±ya katƒ±lmak i√ßin mikrofona (ve baƒülƒ±ysa kameraya) tarayƒ±cƒ± √ºzerinden izin vermen gerekiyor.
                    </p>
                    <button id="requestMediaBtn"
                            class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium">
                        <i class="fa-solid fa-unlock mr-2"></i>ƒ∞zin Ver
                    </button>
                    <p id="mediaError" class="mt-3 text-xs text-rose-400 hidden"></p>
                </div>
            </div>
        </section>

        <!-- Side Panel -->
        <aside id="sidePanel"
               class="hidden lg:flex flex-col w-80 border-l border-slate-800 bg-slate-950/95 flex-shrink-0">
            <!-- Katƒ±lƒ±mcƒ±lar -->
            <div class="flex-shrink-0 border-b border-slate-800">
                <div class="px-4 py-3 flex items-center justify-between">
                    <h2 class="text-sm font-semibold">
                        Katƒ±lƒ±mcƒ±lar (<span id="participantCount">1</span>)
                    </h2>
                    <!-- Mobilde kapat butonu -->
                    <button id="btnSideClose"
                            class="lg:hidden text-slate-400 hover:text-slate-200 text-xs">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <ul id="participantsList"
                    class="px-3 pb-3 space-y-1 text-xs max-h-32 overflow-y-auto"></ul>
            </div>
            
            <!-- Sohbet -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex-shrink-0 px-4 py-2 border-b border-slate-800">
                    <h3 class="text-sm font-semibold">Sohbet</h3>
                </div>
                
                <!-- Chat mesajlarƒ± - SABƒ∞T Y√úKSEKLƒ∞K -->
                <div id="chatMessages"
                     class="flex-1 px-4 py-2 space-y-2 text-sm overflow-y-auto">
                    <div class="text-center text-[11px] text-slate-500 py-2">
                        Sohbete ho≈ü geldin!
                    </div>
                </div>
                
                <!-- Chat input -->
                <form id="chatForm"
                      class="flex-shrink-0 border-t border-slate-800 px-3 py-2 flex gap-2">
                    <input id="chatInput" type="text" autocomplete="off"
                           class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500"
                           placeholder="Mesaj yaz..." />
                    <button type="submit"
                            class="h-10 w-10 rounded-full bg-violet-600 hover:bg-violet-500 text-white flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </aside>
    </main>

    <!-- Bottom Controls -->
    <footer class="flex-shrink-0 border-t border-slate-800 bg-slate-950/95">
        <div class="max-w-5xl mx-auto px-3 py-2 sm:px-4 sm:py-3 flex items-center justify-center gap-1.5 sm:gap-3">
            <button id="btnMic"
                    class="h-11 w-11 sm:h-12 sm:w-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors"
                    title="Mikrofon">
                <i class="fa-solid fa-microphone text-lg"></i>
            </button>
            <button id="btnCam"
                    class="h-11 w-11 sm:h-12 sm:w-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors"
                    title="Kamera">
                <i class="fa-solid fa-video text-lg"></i>
            </button>
            <button id="btnScreen"
                    class="h-11 w-11 sm:h-12 sm:w-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors"
                    title="Ekran Payla≈ü">
                <i class="fa-solid fa-display text-lg"></i>
            </button>

            <button id="btnHand"
                    class="h-11 w-11 sm:h-12 sm:w-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors"
                    title="El kaldƒ±r">
                <i class="fa-solid fa-hand-paper text-lg"></i>
            </button>
            <button id="btnChatToggle"
                    class="lg:hidden h-11 w-11 sm:h-12 sm:w-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors"
                    title="Sohbet">
                <i class="fa-solid fa-comments text-lg"></i>
            </button>

            <!-- Emoji reaksiyonlarƒ± -->
            <div id="reactionBar"
                 class="hidden sm:flex items-center gap-1 ml-2">
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üëç">üëç</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üëè">üëè</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üòÇ">üòÇ</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üòÆ">üòÆ</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üéâ">üéâ</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üî•">üî•</button>
                <button class="h-8 w-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-base reaction-btn"
                        data-emoji="üëÄ">üëÄ</button>
            </div>

            <div class="w-px h-8 bg-slate-700 mx-1"></div>
            <button id="leaveBtn"
                    class="h-11 sm:h-12 px-4 sm:px-5 rounded-full bg-rose-600 hover:bg-rose-500 text-xs sm:text-sm font-semibold flex items-center gap-2 transition-colors">
                <i class="fa-solid fa-phone-slash"></i>
                <span class="hidden sm:inline">Ayrƒ±l</span>
            </button>
        </div>
    </footer>

    <script>
        // URL PARAMETRELERƒ∞
        const params = new URLSearchParams(window.location.search);
        let roomCode = params.get("room");
        let userName = params.get("name") || "Misafir" + Math.floor(100 + Math.random() * 900);
        if (!roomCode || !/^\d{6}$/.test(roomCode)) {
            window.location.href = "index.html";
        }
        document.getElementById("roomCodeText").textContent = roomCode;
        document.getElementById("currentUserName").textContent = userName;
        document.getElementById("selfNameTag").textContent = userName;

        // DOM ELEMANLARI
        const localVideo = document.getElementById("localVideo");
        const localCamOff = document.getElementById("localCamOff");
        const localStatusDot = document.getElementById("localStatusDot");
        const localMicIcon = document.getElementById("localMicIcon");
        const localTile = document.getElementById("localTile");
        const videoGrid = document.getElementById("videoGrid");
        const sidePanel = document.getElementById("sidePanel");
        const participantsList = document.getElementById("participantsList");
        const participantCountEl = document.getElementById("participantCount");
        const chatForm = document.getElementById("chatForm");
        const chatInput = document.getElementById("chatInput");
        const chatMessages = document.getElementById("chatMessages");
        const connectionStatus = document.getElementById("connectionStatus");
        const mediaPermissionWarning = document.getElementById("mediaPermissionWarning");
        const requestMediaBtn = document.getElementById("requestMediaBtn");
        const mediaError = document.getElementById("mediaError");

        const btnMic = document.getElementById("btnMic");
        const btnCam = document.getElementById("btnCam");
        const btnScreen = document.getElementById("btnScreen");
        const btnHand = document.getElementById("btnHand");
        const btnChatToggle = document.getElementById("btnChatToggle");
        const leaveBtn = document.getElementById("leaveBtn");
        const copyCodeBtn = document.getElementById("copyCodeBtn");
        const btnLockRoom = document.getElementById("btnLockRoom");
        const reactionButtons = document.querySelectorAll(".reaction-btn");
        const btnSideClose = document.getElementById("btnSideClose");

        // DURUM
        const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        let localStream = null;
        let screenStream = null;
        let isScreenSharing = false;
        let isScreenSharingWithAudio = false;
        let micEnabled = true;
        let camEnabled = true;
        let hasCamera = true;
        let socket = null;
        let clientId = null;
        let mediaReady = false;

        let isHostUser = false;
        let hostId = null;
        let roomLocked = false;

        let currentScreenSharerId = null;
        let handRaised = false;

        const peers = new Map();        // peerId -> { pc, stream, videoEl, tileEl, name, videoSender }
        const participants = new Map(); // clientId -> { name, isSelf, isHost, handRaised }

        const signalingServerUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;

        // Konu≈üma g√∂stergesi
        let audioContext = null;
        const speakingMonitors = new Map(); // id -> { analyser, dataArray, tileEl, speaking, lastHigh, source }

        // Local ekran tile referansƒ±
        let selfScreenTileEl = null;
        let selfScreenVideoEl = null;

        // AudioContext & konu≈üma takibi
        function getAudioContext() {
            if (audioContext) return audioContext;
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) {
                console.warn("AudioContext desteklenmiyor.");
                return null;
            }
            audioContext = new AC();
            return audioContext;
        }

        function monitorStreamAudio(id, stream, tileEl) {
            const ac = getAudioContext();
            if (!ac || !stream) return;
            if (speakingMonitors.has(id)) return;

            const audioTracks = stream.getAudioTracks();
            if (!audioTracks.length) return;

            const mediaStream = new MediaStream([audioTracks[0]]);
            let source;
            try {
                source = ac.createMediaStreamSource(mediaStream);
            } catch (e) {
                console.warn("Konu≈üma g√∂stergesi i√ßin kaynak olu≈üturulamadƒ±:", e);
                return;
            }

            const analyser = ac.createAnalyser();
            analyser.fftSize = 1024;
            source.connect(analyser);
            const dataArray = new Uint8Array(analyser.fftSize);

            speakingMonitors.set(id, {
                analyser,
                dataArray,
                tileEl,
                speaking: false,
                lastHigh: 0,
                source
            });
        }

        function startSpeakingDetectionLoop() {
            const ac = getAudioContext();
            if (!ac) return;
            if (startSpeakingDetectionLoop.started) return;
            startSpeakingDetectionLoop.started = true;

            const THRESHOLD = 0.02;
            const HOLD_MS = 300;

            function loop() {
                const now = performance.now();
                speakingMonitors.forEach((m) => {
                    m.analyser.getByteTimeDomainData(m.dataArray);
                    let sum = 0;
                    for (let i = 0; i < m.dataArray.length; i++) {
                        const v = (m.dataArray[i] - 128) / 128;
                        sum += v * v;
                    }
                    const rms = Math.sqrt(sum / m.dataArray.length);

                    if (rms > THRESHOLD) {
                        m.lastHigh = now;
                    }

                    const isSpeaking = (now - m.lastHigh) < HOLD_MS;

                    if (isSpeaking !== m.speaking) {
                        m.speaking = isSpeaking;
                        if (m.tileEl) {
                            m.tileEl.classList.toggle("tile-speaking", isSpeaking);
                        }
                    }
                });

                requestAnimationFrame(loop);
            }

            requestAnimationFrame(loop);
        }

        function stopSpeakingMonitor(id) {
            const mon = speakingMonitors.get(id);
            if (!mon) return;
            try { mon.source.disconnect(); } catch {}
            try { mon.analyser.disconnect(); } catch {}
            speakingMonitors.delete(id);
        }

        // Local ekran tile olu≈ütur/g√∂ster
        function showSelfScreenTile() {
            if (!screenStream) return;
            if (!selfScreenTileEl) {
                const tile = document.createElement("div");
                tile.id = "selfScreenTile";
                tile.className = "relative rounded-2xl overflow-hidden bg-slate-950 border border-slate-800 aspect-video";

                const video = document.createElement("video");
                video.autoplay = true;
                video.playsInline = true;
                video.muted = true; // ekran sesi geri d√∂nmesin
                video.className = "w-full h-full object-cover bg-black";
                video.srcObject = screenStream;

                const labelTop = document.createElement("div");
                labelTop.className = "absolute top-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1";
                labelTop.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-400"></span><span>Sen (Ekran)</span>`;

                const labelBottom = document.createElement("div");
                labelBottom.className = "absolute bottom-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1";
                labelBottom.innerHTML = `<i class="fa-solid fa-display text-sky-400"></i><span>Ekran Payla≈üƒ±mƒ±</span>`;

                tile.appendChild(video);
                tile.appendChild(labelTop);
                tile.appendChild(labelBottom);

                videoGrid.appendChild(tile);

                selfScreenTileEl = tile;
                selfScreenVideoEl = video;
            } else {
                selfScreenVideoEl.srcObject = screenStream;
                selfScreenTileEl.classList.remove("hidden");
            }
        }

        function hideSelfScreenTile() {
            if (!selfScreenTileEl) return;
            selfScreenTileEl.remove();
            selfScreenTileEl = null;
            selfScreenVideoEl = null;
        }

        // Spotlight
        function updateSpotlightUI() {
            localTile.classList.remove("tile-spotlight");
            if (selfScreenTileEl) selfScreenTileEl.classList.remove("tile-spotlight");
            peers.forEach((peerInfo) => {
                if (peerInfo.tileEl) peerInfo.tileEl.classList.remove("tile-spotlight");
            });

            if (!currentScreenSharerId) return;

            if (currentScreenSharerId === clientId) {
                if (selfScreenTileEl) {
                    selfScreenTileEl.classList.add("tile-spotlight");
                } else {
                    localTile.classList.add("tile-spotlight");
                }
            } else {
                const p = peers.get(currentScreenSharerId);
                if (p && p.tileEl) p.tileEl.classList.add("tile-spotlight");
            }
        }

        // Emoji reaksiyon
        function showReaction(peerId, emoji) {
            let tileEl = null;
            if (peerId === clientId) {
                tileEl = localTile;
            } else {
                const peer = peers.get(peerId);
                tileEl = peer && peer.tileEl ? peer.tileEl : null;
            }
            if (!tileEl) return;

            const el = document.createElement("div");
            el.textContent = emoji;
            el.className = "absolute animate-reaction text-3xl pointer-events-none";
            el.style.left = "50%";
            el.style.top = "50%";
            el.style.transform = "translate(-50%, -50%)";
            tileEl.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        // Baƒülantƒ± durumu
        function updateConnectionStatus(status, type = 'info') {
            const colors = {
                'connecting': 'bg-yellow-900/50 border-yellow-700 text-yellow-400',
                'connected': 'bg-emerald-900/50 border-emerald-700 text-emerald-400',
                'error': 'bg-rose-900/50 border-rose-700 text-rose-400'
            };
            const icons = {
                'connecting': '<i class="fa-solid fa-spinner fa-spin"></i>',
                'connected': '<i class="fa-solid fa-circle"></i>',
                'error': '<i class="fa-solid fa-exclamation-triangle"></i>'
            };
            
            connectionStatus.innerHTML = `
                <span class="flex items-center gap-1 px-2 py-1 rounded-full ${colors[type]} text-xs">
                    ${icons[type]}
                    <span>${status}</span>
                </span>
            `;
        }

        // MEDYA
        async function requestMediaPermission() {
            if (mediaReady && localStream) {
                mediaPermissionWarning.classList.add("hidden");
                return true;
            }

            console.log("[MEDYA] ƒ∞zin isteniyor (ses+g√∂r√ºnt√º)...");
            
            const audioConstraints = {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            };

            const videoConstraints = {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "user"
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: audioConstraints,
                    video: videoConstraints
                });
                hasCamera = true;
            } catch (err) {
                console.error("[MEDYA] ƒ∞zin hatasƒ± (ilk deneme):", err);

                if (err.name === "NotFoundError" || err.name === "OverconstrainedError") {
                    try {
                        console.log("[MEDYA] Kamera bulunamadƒ±, sadece mikrofon isteniyor...");
                        localStream = await navigator.mediaDevices.getUserMedia({
                            audio: audioConstraints,
                            video: false
                        });
                        hasCamera = false;
                    } catch (err2) {
                        console.error("[MEDYA] ƒ∞zin hatasƒ± (sadece mikrofon):", err2);
                        showMediaError(err2);
                        return false;
                    }
                } else {
                    showMediaError(err);
                    return false;
                }
            }

            console.log("[MEDYA] ƒ∞zin verildi, stream alƒ±ndƒ±");
            
            localVideo.srcObject = localStream;
            mediaReady = true;

            monitorStreamAudio("local", localStream, localTile);
            startSpeakingDetectionLoop();

            mediaPermissionWarning.classList.add("hidden");
            localStatusDot.classList.remove("bg-yellow-400");
            localStatusDot.classList.add("bg-emerald-400");
            
            if (!hasCamera || localStream.getVideoTracks().length === 0) {
                camEnabled = false;
                localCamOff.classList.remove("hidden");
                btnCam.disabled = true;
                btnCam.classList.add("opacity-50", "cursor-not-allowed");
                btnCam.title = "Bu cihazda kamera yok";
                appendSystemMessage("Bu cihazda kamera bulunamadƒ±ƒüƒ± i√ßin toplantƒ±ya sadece sesli katƒ±ldƒ±n.");
            }

            updateMicUI();
            updateCamUI();
            
            connectSignaling();
            return true;
        }

        function showMediaError(err) {
            console.error("[MEDYA] ƒ∞zin hatasƒ±:", err);
            let errorMessage = "Bilinmeyen hata";
            if (err.name === "NotAllowedError") {
                errorMessage = "Kamera/mikrofon izni reddedildi. Tarayƒ±cƒ± adres √ßubuƒüundaki kilit simgesine tƒ±klayƒ±p izinleri tekrar a√ßman gerekiyor.";
            } else if (err.name === "NotFoundError") {
                errorMessage = "Cihazƒ±nda kullanƒ±labilir kamera veya mikrofon bulunamadƒ±.";
            } else if (err.name === "NotReadableError") {
                errorMessage = "Kamera veya mikrofon ba≈üka bir uygulama tarafƒ±ndan kullanƒ±lƒ±yor.";
            } else if (err.name === "OverconstrainedError") {
                errorMessage = "ƒ∞stenen video ayarlarƒ± bu cihaz tarafƒ±ndan desteklenmiyor.";
            }
            mediaError.textContent = errorMessage;
            mediaError.classList.remove("hidden");
        }
        
        requestMediaBtn.addEventListener("click", async () => {
            const ac = getAudioContext();
            if (ac && ac.state === "suspended") {
                try { await ac.resume(); } catch {}
            }
            await requestMediaPermission();
        });

        // KATILIMCI Lƒ∞STESƒ∞ + HOST
        function updateParticipantCount() {
            participantCountEl.textContent = participants.size;
        }

        function renderParticipants() {
            participantsList.innerHTML = "";
            participants.forEach((p, id) => {
                const li = document.createElement("li");
                li.className = "flex items-center gap-2 py-1.5 px-2 rounded-lg hover:bg-slate-900/70";

                const labels = [];
                if (p.handRaised) {
                    labels.push('<span class="text-amber-400 text-[12px]" title="El kaldƒ±rdƒ±">‚úã</span>');
                }
                if (p.isSelf) {
                    labels.push('<span class="text-sky-400 text-[10px] flex-shrink-0">(Sen)</span>');
                }
                if (p.isHost) {
                    labels.push('<i class="fa-solid fa-crown text-amber-400 text-[11px]"></i>');
                }

                let controls = "";
                if (isHostUser && !p.isSelf) {
                    controls = `
                        <div class="ml-auto flex items-center gap-1">
                            <button class="text-slate-500 hover:text-rose-400 text-xs mute-btn" data-id="${id}" title="Mikrofonunu kapat">
                                <i class="fa-solid fa-microphone-slash"></i>
                            </button>
                            <button class="text-slate-500 hover:text-rose-500 text-xs kick-btn" data-id="${id}" title="Kullanƒ±cƒ±yƒ± odadan at">
                                <i class="fa-solid fa-user-xmark"></i>
                            </button>
                        </div>
                    `;
                }

                li.innerHTML = `
                    <span class="h-2 w-2 rounded-full bg-emerald-400 flex-shrink-0"></span>
                    <span class="truncate">${p.name}</span>
                    ${labels.join("&nbsp;")}
                    ${controls}
                `;
                participantsList.appendChild(li);
            });
            updateParticipantCount();
        }

        function addOrUpdateParticipant(id, name, isSelf = false, isHost = false) {
            const existing = participants.get(id) || {};
            participants.set(id, {
                name: name ?? existing.name ?? "Katƒ±lƒ±mcƒ±",
                isSelf: isSelf || existing.isSelf || false,
                isHost: isHost || existing.isHost || false,
                handRaised: existing.handRaised || false
            });
            renderParticipants();
        }

        function removeParticipant(id) {
            participants.delete(id);
            renderParticipants();
        }

        function updateLockButtonUI() {
            if (!btnLockRoom) return;
            if (!isHostUser) {
                btnLockRoom.classList.add("hidden");
                return;
            }
            btnLockRoom.classList.remove("hidden");
            const icon = btnLockRoom.querySelector("i");
            const span = btnLockRoom.querySelector("span");
            if (roomLocked) {
                icon.className = "fa-solid fa-lock";
                if (span) span.textContent = "Oda kilitli";
                btnLockRoom.classList.add("bg-amber-900/60", "border-amber-600", "text-amber-300");
                btnLockRoom.classList.remove("bg-slate-900", "border-slate-700");
            } else {
                icon.className = "fa-solid fa-lock-open";
                if (span) span.textContent = "Odayƒ± kilitle";
                btnLockRoom.classList.add("bg-slate-900", "border-slate-700");
                btnLockRoom.classList.remove("bg-amber-900/60", "border-amber-600", "text-amber-300");
            }
        }

        function updateHostControlsVisibility() {
            updateLockButtonUI();
            renderParticipants();
        }

        btnLockRoom.addEventListener("click", () => {
            if (!isHostUser || !socket || socket.readyState !== WebSocket.OPEN) return;
            const newState = !roomLocked;
            socket.send(JSON.stringify({
                type: "control",
                room: roomCode,
                action: "lock-room",
                value: newState
            }));
        });

        participantsList.addEventListener("click", (e) => {
            const muteBtn = e.target.closest(".mute-btn");
            if (muteBtn) {
                if (!isHostUser || !socket || socket.readyState !== WebSocket.OPEN) return;
                const targetId = muteBtn.dataset.id;
                if (!targetId) return;
                socket.send(JSON.stringify({
                    type: "control",
                    room: roomCode,
                    action: "mute-mic",
                    targetId
                }));
                return;
            }

            const kickBtn = e.target.closest(".kick-btn");
            if (kickBtn) {
                if (!isHostUser || !socket || socket.readyState !== WebSocket.OPEN) return;
                const targetId = kickBtn.dataset.id;
                if (!targetId) return;
                if (!confirm("Bu katƒ±lƒ±mcƒ±yƒ± odadan atmak istiyor musun?")) return;
                socket.send(JSON.stringify({
                    type: "control",
                    room: roomCode,
                    action: "kick",
                    targetId
                }));
                return;
            }
        });

        // Sohbet
        function scrollChatToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        function appendMessage(author, text, self = false) {
            const div = document.createElement("div");
            div.className = `flex ${self ? "justify-end" : "justify-start"}`;
            const time = new Date().toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });
            div.innerHTML = `
                <div class="max-w-[85%] px-3 py-2 rounded-2xl text-sm ${self ? "bg-violet-600 text-white rounded-br-sm" : "bg-slate-800 text-slate-100 rounded-bl-sm"}">
                    <div class="flex items-center gap-2 mb-0.5">
                        <span class="text-[11px] font-medium ${self ? "text-violet-200" : "text-slate-400"}">${author}</span>
                        <span class="text-[10px] ${self ? "text-violet-300" : "text-slate-500"}">${time}</span>
                    </div>
                    <div class="break-words">${escapeHtml(text)}</div>
                </div>
            `;
            chatMessages.appendChild(div);
            scrollChatToBottom();
        }

        function appendSystemMessage(text) {
            const div = document.createElement("div");
            div.className = "text-center py-1";
            div.innerHTML = `<span class="text-[11px] text-slate-500 bg-slate-900/50 px-3 py-1 rounded-full">${text}</span>`;
            chatMessages.appendChild(div);
            scrollChatToBottom();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        chatForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: "chat", room: roomCode, text }));
            chatInput.value = "";
        });

        // Status & reaction helper
        function sendStatus(action, value) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: "status", room: roomCode, action, value }));
        }

        // VIDEO TILE (remote)
        function createRemoteTile(peerId, peerName) {
            const tile = document.createElement("div");
            tile.className = "relative rounded-2xl overflow-hidden bg-slate-950 border border-slate-800 aspect-video";
            tile.dataset.peerId = peerId;
            
            const video = document.createElement("video");
            video.autoplay = true;
            video.playsInline = true;
            video.className = "w-full h-full object-cover bg-black";
            video.muted = false; // remote sesler standartta a√ßƒ±k
            
            const labelTop = document.createElement("div");
            labelTop.className = "absolute top-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1";
            labelTop.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-400 peer-status-dot"></span><span>Katƒ±lƒ±mcƒ±</span>`;
            
            const labelBottom = document.createElement("div");
            labelBottom.className = "absolute bottom-2 left-2 px-2 py-0.5 rounded-full bg-black/70 text-xs flex items-center gap-1";
            labelBottom.innerHTML = `<i class="fa-solid fa-microphone text-emerald-400"></i><span>${peerName}</span>`;

            // Kamera kapalƒ± overlay'i (remote)
            const camOffOverlay = document.createElement("div");
            camOffOverlay.className = "remote-cam-off absolute inset-0 bg-slate-900 flex items-center justify-center hidden";
            camOffOverlay.innerHTML = `
                <div class="text-center">
                    <i class="fa-solid fa-video-slash text-4xl text-slate-600 mb-2"></i>
                    <p class="text-sm text-slate-500">Kamera kapalƒ±</p>
                </div>
            `;
            
            tile.appendChild(video);
            tile.appendChild(labelTop);
            tile.appendChild(labelBottom);
            tile.appendChild(camOffOverlay);
            videoGrid.appendChild(tile);
            
            return { videoEl: video, tileEl: tile };
        }

        // WEBRTC
        async function getOrCreatePeerConnection(peerId, peerName) {
            if (peers.has(peerId)) return peers.get(peerId);
            if (!localStream) {
                console.error("[PEER] Local stream yok!");
                return null;
            }
            
            console.log(`[PEER] Yeni baƒülantƒ± olu≈üturuluyor: ${peerName}`);
            const pc = new RTCPeerConnection(iceConfig);
            
            // Ses (mikrofon)
            localStream.getAudioTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // Video (kamera veya ekran)
            let initialVideoTrack = null;
            let initialStreamForVideo = null;

            if (isScreenSharing && screenStream) {
                initialVideoTrack = screenStream.getVideoTracks()[0] || null;
                initialStreamForVideo = screenStream;
            } else {
                initialVideoTrack = localStream.getVideoTracks()[0] || null;
                initialStreamForVideo = localStream;
            }

            let videoSender = null;
            if (initialVideoTrack) {
                videoSender = pc.addTrack(initialVideoTrack, initialStreamForVideo);
            } else {
                const transceiver = pc.addTransceiver("video");
                videoSender = transceiver.sender;
            }

            // Ekran payla≈üƒ±mƒ± aktif ve sesli ise, sistem sesini de g√∂nder
            if (isScreenSharing && screenStream && isScreenSharingWithAudio) {
                const screenAudioTrack = screenStream.getAudioTracks()[0];
                if (screenAudioTrack) {
                    pc.addTrack(screenAudioTrack, screenStream);
                }
            }
            
            const { videoEl, tileEl } = createRemoteTile(peerId, peerName);
            const peerInfo = { pc, stream: null, videoEl, tileEl, name: peerName, videoSender };
            peers.set(peerId, peerInfo);

            // Eƒüer biz ≈üu anda ekran sesini de payla≈üƒ±yorsak,
            // yankƒ±yƒ± azaltmak i√ßin bu yeni remote videoyu da sessize al
            if (isScreenSharingWithAudio) {
                videoEl.muted = true;
                videoEl.dataset.mutedByScreenShare = "1";
            }
            
            pc.ontrack = (event) => {
                console.log(`[PEER] Remote track alƒ±ndƒ±: ${event.track.kind}`);
                
                if (!peerInfo.stream) {
                    peerInfo.stream = new MediaStream();
                    peerInfo.videoEl.srcObject = peerInfo.stream;
                }
                peerInfo.stream.addTrack(event.track);

                if (event.track.kind === "audio") {
                    monitorStreamAudio(peerId, peerInfo.stream, tileEl);
                    startSpeakingDetectionLoop();
                }
            };
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignal(peerId, { type: "candidate", candidate: event.candidate });
                }
            };
            
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === "connected") {
                    const dot = tileEl.querySelector(".peer-status-dot");
                    if (dot) {
                        dot.classList.remove("bg-yellow-400");
                        dot.classList.add("bg-emerald-400");
                    }
                }
            };
            
            return peerInfo;
        }

        function removePeer(peerId) {
            const peerInfo = peers.get(peerId);
            if (!peerInfo) return;
            try { peerInfo.pc.close(); } catch (e) {}
            if (peerInfo.tileEl) peerInfo.tileEl.remove();
            stopSpeakingMonitor(peerId);
            peers.delete(peerId);
        }

        async function handleSignal(fromId, data) {
            const peerName = participants.get(fromId)?.name || "Katƒ±lƒ±mcƒ±";
            const peerInfo = await getOrCreatePeerConnection(fromId, peerName);
            if (!peerInfo) return;
            const pc = peerInfo.pc;
            try {
                if (data.type === "offer") {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    sendSignal(fromId, { type: "answer", sdp: answer });
                } else if (data.type === "answer") {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                } else if (data.type === "candidate") {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (err) {
                console.error("[SIGNAL] Hata:", err);
            }
        }

        async function startCallToPeer(peerId, peerName) {
            const peerInfo = await getOrCreatePeerConnection(peerId, peerName);
            if (!peerInfo) return;
            const pc = peerInfo.pc;
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal(peerId, { type: "offer", sdp: offer });
            } catch (err) {
                console.error("[CALL] Offer hatasƒ±:", err);
            }
        }

        // WEBSOCKET
        function connectSignaling() {
            socket = new WebSocket(signalingServerUrl);
            updateConnectionStatus("Baƒülanƒ±yor...", "connecting");
            
            socket.addEventListener("open", () => {
                socket.send(JSON.stringify({ type: "join", room: roomCode, name: userName }));
            });
            
            socket.addEventListener("message", async (event) => {
                let msg;
                try { msg = JSON.parse(event.data); } catch { return; }
                
                switch (msg.type) {
                    case "joined":
                        clientId = msg.id;
                        hostId = msg.hostId;
                        isHostUser = msg.isHost;
                        roomLocked = msg.locked;

                        addOrUpdateParticipant(clientId, userName, true, isHostUser);
                        appendSystemMessage("Toplantƒ±ya baƒülandƒ±n!");
                        updateConnectionStatus("Baƒülandƒ±", "connected");
                        updateHostControlsVisibility();
                        
                        for (const peer of msg.peers || []) {
                            addOrUpdateParticipant(peer.id, peer.name, false, peer.isHost);
                            appendSystemMessage(`${peer.name} odada`);
                            await startCallToPeer(peer.id, peer.name);
                        }

                        // ƒ∞lk kamera durumu (kameran varsa)
                        sendStatus("camera", camEnabled && hasCamera && (localStream?.getVideoTracks().length || 0) > 0);
                        break;
                        
                    case "peer-joined":
                        addOrUpdateParticipant(msg.id, msg.name, false, msg.isHost);
                        appendSystemMessage(`${msg.name} katƒ±ldƒ±`);
                        await getOrCreatePeerConnection(msg.id, msg.name);
                        break;
                        
                    case "signal":
                        await handleSignal(msg.from, msg.data);
                        break;
                        
                    case "peer-left":
                        appendSystemMessage(`${msg.name || "Biri"} ayrƒ±ldƒ±`);
                        removePeer(msg.id);
                        removeParticipant(msg.id);
                        if (currentScreenSharerId === msg.id) {
                            currentScreenSharerId = null;
                            updateSpotlightUI();
                        }
                        break;
                        
                    case "chat":
                        appendMessage(msg.from, msg.text, msg.senderId === clientId);
                        break;

                    case "room-lock":
                        roomLocked = msg.locked;
                        updateLockButtonUI();
                        appendSystemMessage(
                            roomLocked
                                ? "Oda kilitlendi, yeni katƒ±lƒ±mcƒ±lar alƒ±nmayacak."
                                : "Oda kilidi kaldƒ±rƒ±ldƒ±, yeni katƒ±lƒ±mcƒ±lar katƒ±labilir."
                        );
                        break;

                    case "host-changed":
                        hostId = msg.hostId;
                        isHostUser = (hostId === clientId);
                        participants.forEach((p, id) => { p.isHost = (id === hostId); });
                        updateHostControlsVisibility();
                        const newHostName = participants.get(hostId)?.name || "Biri";
                        appendSystemMessage(`${newHostName} toplantƒ± sahibi oldu.`);
                        break;

                    case "control":
                        if (msg.action === "mute-mic") {
                            if (localStream) {
                                localStream.getAudioTracks().forEach(t => (t.enabled = false));
                            }
                            micEnabled = false;
                            updateMicUI();
                            appendSystemMessage("Toplantƒ± sahibi mikrofonunu kapattƒ±.");
                        } else if (msg.action === "kick") {
                            alert("Toplantƒ± sahibi seni odadan √ßƒ±kardƒ±.");
                            cleanup();
                            window.location.href = "index.html";
                        }
                        break;

                    case "status":
                        if (msg.action === "hand") {
                            const p = participants.get(msg.id);
                            if (p) {
                                p.handRaised = !!msg.value;
                                participants.set(msg.id, p);
                                renderParticipants();
                                if (msg.id !== clientId && msg.value) {
                                    appendSystemMessage(`${p.name} el kaldƒ±rdƒ±.`);
                                }
                            }
                        } else if (msg.action === "screen-share") {
                            const p = participants.get(msg.id);
                            if (msg.value) {
                                currentScreenSharerId = msg.id;
                                updateSpotlightUI();
                                if (msg.id !== clientId) {
                                    appendSystemMessage(`${(p && p.name) || "Biri"} ekran payla≈üƒ±mƒ± ba≈ülattƒ±.`);
                                }
                            } else {
                                if (currentScreenSharerId === msg.id) {
                                    currentScreenSharerId = null;
                                    updateSpotlightUI();
                                }
                                if (msg.id !== clientId) {
                                    appendSystemMessage(`${(p && p.name) || "Biri"} ekran payla≈üƒ±mƒ±nƒ± durdurdu.`);
                                }
                            }
                        } else if (msg.action === "camera") {
                            // Kamera a√ß/kapat durumu
                            if (msg.id === clientId) {
                                // Kendi kameramƒ±zƒ± local UI ile y√∂netiyoruz
                            } else {
                                const peerInfo = peers.get(msg.id);
                                if (peerInfo && peerInfo.tileEl) {
                                    const overlay = peerInfo.tileEl.querySelector(".remote-cam-off");
                                    if (overlay) {
                                        if (msg.value) {
                                            overlay.classList.add("hidden");
                                        } else {
                                            overlay.classList.remove("hidden");
                                        }
                                    }
                                }
                            }
                        }
                        break;

                    case "reaction":
                        showReaction(msg.id, msg.emoji);
                        break;
                        
                    case "full":
                        alert("Oda dolu!");
                        window.location.href = "index.html";
                        break;
                        
                    case "locked":
                        alert("Oda kilitli!");
                        window.location.href = "index.html";
                        break;
                }
            });
            
            socket.addEventListener("close", () => {
                updateConnectionStatus("Baƒülantƒ± kesildi", "error");
            });
            
            socket.addEventListener("error", (err) => {
                console.error("[WS] Hata:", err);
                updateConnectionStatus("Baƒülantƒ± hatasƒ±", "error");
            });
        }

        function sendSignal(toId, data) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "signal", room: roomCode, to: toId, data }));
            }
        }

        // KONTROLLER
        function updateMicUI() {
            const icon = btnMic.querySelector("i");
            if (micEnabled) {
                btnMic.classList.remove("bg-rose-600");
                btnMic.classList.add("bg-slate-800");
                icon.className = "fa-solid fa-microphone text-lg";
                localMicIcon.className = "fa-solid fa-microphone text-emerald-400";
            } else {
                btnMic.classList.remove("bg-slate-800");
                btnMic.classList.add("bg-rose-600");
                icon.className = "fa-solid fa-microphone-slash text-lg";
                localMicIcon.className = "fa-solid fa-microphone-slash text-rose-400";
            }
        }

        function updateCamUI() {
            const icon = btnCam.querySelector("i");
            if (camEnabled) {
                btnCam.classList.remove("bg-rose-600");
                btnCam.classList.add("bg-slate-800");
                icon.className = "fa-solid fa-video text-lg";
                localCamOff.classList.add("hidden");
            } else {
                btnCam.classList.remove("bg-slate-800");
                btnCam.classList.add("bg-rose-600");
                icon.className = "fa-solid fa-video-slash text-lg";
                localCamOff.classList.remove("hidden");
            }
        }

        function updateScreenUI(active) {
            const icon = btnScreen.querySelector("i");
            if (active) {
                btnScreen.classList.remove("bg-slate-800");
                btnScreen.classList.add("bg-emerald-600");
                icon.classList.add("text-white");
            } else {
                btnScreen.classList.remove("bg-emerald-600");
                btnScreen.classList.add("bg-slate-800");
                icon.classList.remove("text-white");
            }
        }

        function updateHandUI() {
            const icon = btnHand.querySelector("i");
            if (handRaised) {
                btnHand.classList.remove("bg-slate-800");
                btnHand.classList.add("bg-amber-600");
                icon.classList.add("text-white");
            } else {
                btnHand.classList.add("bg-slate-800");
                btnHand.classList.remove("bg-amber-600");
                icon.classList.remove("text-white");
            }
        }

        btnMic.addEventListener("click", () => {
            if (!localStream) return;
            micEnabled = !micEnabled;
            localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
            updateMicUI();
        });

        btnCam.addEventListener("click", () => {
            if (!localStream || btnCam.disabled) return;
            camEnabled = !camEnabled;
            localStream.getVideoTracks().forEach(t => t.enabled = camEnabled);
            updateCamUI();
            // Kamera durumu diƒüerlerine bildirilsin
            sendStatus("camera", camEnabled && hasCamera && (localStream.getVideoTracks().length || 0) > 0);
        });

        // El kaldƒ±r
        btnHand.addEventListener("click", () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            handRaised = !handRaised;
            sendStatus("hand", handRaised);
            updateHandUI();
            const self = participants.get(clientId);
            if (self) {
                self.handRaised = handRaised;
                participants.set(clientId, self);
                renderParticipants();
            }
        });

        // Emoji butonlarƒ±
        reactionButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                if (!socket || socket.readyState !== WebSocket.OPEN) return;
                const emoji = btn.dataset.emoji;
                if (!emoji) return;
                socket.send(JSON.stringify({ type: "reaction", room: roomCode, emoji }));
                showReaction(clientId, emoji);
            });
        });

        // Ekran payla≈üƒ±mƒ±
        btnScreen.addEventListener("click", async () => {
            if (!localStream) return;
            
            if (!isScreenSharing) {
                if (currentScreenSharerId && currentScreenSharerId !== clientId) {
                    alert("≈ûu anda zaten birisi ekran payla≈üƒ±yor.");
                    return;
                }

                try {
                    console.log("[SCREEN] Ekran payla≈üƒ±mƒ± ba≈ülatƒ±lƒ±yor...");
                    // audio: true ‚Üí tarayƒ±cƒ± se√ßim ekranƒ±nda ‚ÄúShare tab audio / Share system audio‚Äù
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { cursor: "always" },
                        audio: true
                    });

                    const screenVideoTrack = screenStream.getVideoTracks()[0];
                    const screenAudioTrack = screenStream.getAudioTracks()[0];
                    isScreenSharingWithAudio = !!screenAudioTrack;

                    // Local ekranda da ba≈ükasƒ± gibi g√∂r
                    showSelfScreenTile();

                    // T√ºm peer'lara ekran video track'i g√∂nder
                    peers.forEach((peerInfo, peerId) => {
                        const sender = peerInfo.videoSender;
                        if (sender) {
                            sender.replaceTrack(screenVideoTrack);
                        }
                        // Sistem sesi de varsa g√∂nder
                        if (isScreenSharingWithAudio && screenAudioTrack) {
                            peerInfo.pc.addTrack(screenAudioTrack, screenStream);
                        }
                    });

                    // Eƒüer ekran sesini de payla≈üƒ±yorsak, yankƒ±yƒ± azaltmak i√ßin
                    // kendi tarafƒ±mƒ±zda remote katƒ±lƒ±mcƒ±larƒ±n seslerini sessize al
                    if (isScreenSharingWithAudio) {
                        peers.forEach((peerInfo) => {
                            if (peerInfo.videoEl) {
                                peerInfo.videoEl.muted = true;
                                peerInfo.videoEl.dataset.mutedByScreenShare = "1";
                            }
                        });
                        appendSystemMessage("Ekran sesi payla≈üƒ±lƒ±yor, yankƒ±yƒ± azaltmak i√ßin toplantƒ± sesini senin tarafƒ±nda susturduk.");
                    }
                    
                    isScreenSharing = true;
                    currentScreenSharerId = clientId;
                    updateScreenUI(true);
                    updateSpotlightUI();
                    sendStatus("screen-share", true);
                    appendSystemMessage(
                        isScreenSharingWithAudio
                            ? "Ekran + sekme/pencere sesi payla≈üƒ±lƒ±yor (tarayƒ±cƒ± se√ßimindeki sese g√∂re)."
                            : "Ekran payla≈üƒ±mƒ± ba≈üladƒ± (tarayƒ±cƒ±daki se√ßeneklere g√∂re ses olmayabilir)."
                    );
                    
                    screenVideoTrack.onended = () => {
                        console.log("[SCREEN] Ekran payla≈üƒ±mƒ± kullanƒ±cƒ± tarafƒ±ndan durduruldu");
                        stopScreenShare();
                    };
                    
                } catch (err) {
                    console.error("[SCREEN] Hata:", err);
                    if (err.name !== "NotAllowedError") {
                        appendSystemMessage("Ekran payla≈üƒ±mƒ± ba≈ülatƒ±lamadƒ±");
                    }
                }
            } else {
                stopScreenShare();
            }
        });

        function stopScreenShare() {
            if (!isScreenSharing) return;
            
            console.log("[SCREEN] Ekran payla≈üƒ±mƒ± durduruluyor...");
            const cameraTrack = localStream?.getVideoTracks()[0] || null;
            
            peers.forEach((peerInfo, peerId) => {
                const sender = peerInfo.videoSender;
                if (sender) {
                    sender.replaceTrack(cameraTrack);
                }
            });
            
            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
            }

            // Bizim tarafta ekran sesi y√ºz√ºnden mute edilen remote videolarƒ± geri a√ß
            peers.forEach((peerInfo) => {
                if (peerInfo.videoEl && peerInfo.videoEl.dataset.mutedByScreenShare === "1") {
                    peerInfo.videoEl.muted = false;
                    delete peerInfo.videoEl.dataset.mutedByScreenShare;
                }
            });
            
            hideSelfScreenTile();
            
            isScreenSharing = false;
            isScreenSharingWithAudio = false;
            if (currentScreenSharerId === clientId) {
                currentScreenSharerId = null;
                sendStatus("screen-share", false);
            }
            updateScreenUI(false);
            updateSpotlightUI();
            appendSystemMessage("Ekran payla≈üƒ±mƒ± durduruldu");
        }

        // Sohbet / Katƒ±lƒ±mcƒ±lar paneli toggle (mobil)
        function openMobileSidePanel() {
            sidePanel.classList.remove("hidden");
            sidePanel.classList.add("flex", "mobile-open");
        }

        function closeMobileSidePanel() {
            sidePanel.classList.remove("flex", "mobile-open");
            sidePanel.classList.add("hidden");
        }

        btnChatToggle.addEventListener("click", () => {
            const isOpen = sidePanel.classList.contains("mobile-open");
            if (isOpen) {
                closeMobileSidePanel();
            } else {
                openMobileSidePanel();
            }
        });

        if (btnSideClose) {
            btnSideClose.addEventListener("click", closeMobileSidePanel);
        }

        // Oda kodu kopyala
        copyCodeBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(roomCode);
                copyCodeBtn.innerHTML = '<i class="fa-solid fa-check text-emerald-400"></i> Kopyalandƒ±';
                setTimeout(() => {
                    copyCodeBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Kopyala';
                }, 2000);
            } catch (e) {
                console.error("Kopyalama hatasƒ±:", e);
            }
        });

        // Ayrƒ±l
        leaveBtn.addEventListener("click", () => {
            if (confirm("Toplantƒ±dan ayrƒ±lmak istediƒüine emin misin?")) {
                cleanup();
                window.location.href = "index.html";
            }
        });

        function cleanup() {
            if (socket) socket.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (screenStream) screenStream.getTracks().forEach(t => t.stop());
            peers.forEach((_, id) => removePeer(id));
            stopSpeakingMonitor("local");
        }

        window.addEventListener("beforeunload", cleanup);

        // BA≈ûLAT
        (async () => {
            console.log("[INIT] Oda:", roomCode, "Kullanƒ±cƒ±:", userName);
            mediaPermissionWarning.classList.remove("hidden");
        })();
    </script>
</body>
</html>