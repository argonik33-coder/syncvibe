<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncVibe - Profesyonel Sohbet Odası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .dark .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
        }
        .message-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        .message-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .message-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .message-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        .typing-dot {
            width: 4px;
            height: 4px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            margin: 0 1px;
            animation: typing-dot 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-dot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 200px;
        }
        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .audio-visualizer {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .audio-level {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.1s ease;
        }
        .participant-muted {
            opacity: 0.6;
        }
        .participant-muted .fa-microphone {
            color: #ef4444 !important;
        }
        .participants-container {
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 400px;
        }
        @media (max-width: 1280px) {
            .participants-container {
                max-width: 100%;
            }
        }
        .system-message {
            text-align: center;
            color: #93c5fd;
            font-style: italic;
            margin: 8px 0;
            font-size: 0.875rem;
        }
        .system-message i {
            margin-right: 6px;
        }
        .audio-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .audio-speaking {
            background: #10b981;
        }
        .audio-muted {
            background: #ef4444;
        }
        /* Tam Ekran Stilleri */
        .video-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
        }
        .video-fullscreen .video-element {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .fullscreen-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            gap: 10px;
        }
        .fullscreen-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .fullscreen-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }
        /* Özel Scrollbar */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        /* Animasyonlar */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        /* Grid Layout */
        .video-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            transition: all 0.3s ease;
        }
        .video-layout.single {
            grid-template-columns: 1fr;
            max-width: 800px;
            margin: 0 auto;
        }
        .video-layout.double {
            grid-template-columns: repeat(2, 1fr);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen transition-colors duration-300">
    <!-- Bildirim Sistemi -->
    <div id="notification" class="fixed top-4 right-4 glass rounded-xl p-4 text-white hidden z-50 transform transition-all duration-300">
        <div class="flex items-center">
            <i class="fas fa-info-circle mr-3 text-lg"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <!-- Header -->
    <header class="glass border-b border-white/20 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <!-- Logo ve Oda Bilgisi -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white/20 rounded-lg p-2">
                            <i class="fas fa-comments text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">SyncVibe</h1>
                            <p class="text-blue-100 text-sm">Profesyonel Sürüm</p>
                        </div>
                    </div>
                    <div class="hidden md:block h-8 w-px bg-white/20"></div>
                    <div class="hidden md:block">
                        <p class="text-blue-100 text-sm">Oda Kodu</p>
                        <p class="text-white font-mono font-bold text-lg" id="currentRoomCode">-----</p>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-blue-100 text-sm">Kullanıcı</p>
                        <p class="text-white font-semibold text-sm" id="currentUserName">-----</p>
                    </div>
                </div>

                <!-- Sağ Kontroller -->
                <div class="flex items-center space-x-4">
                    <!-- Katılımcı Sayısı -->
                    <div class="hidden sm:flex items-center space-x-2 text-white bg-white/20 rounded-lg px-3 py-2">
                        <i class="fas fa-users text-sm"></i>
                        <span class="font-semibold" id="participantCount">0</span>
                    </div>

                    <!-- Bağlantı Durumu -->
                    <div id="connectionStatus" class="hidden sm:flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2">
                        <i class="fas fa-wifi text-sm"></i>
                        <span class="text-sm font-medium">Bağlı</span>
                    </div>

                    <!-- Mikrofon Durumu -->
                    <div id="globalMicStatus" class="hidden sm:flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2">
                        <i class="fas fa-microphone text-sm"></i>
                        <span class="text-sm font-medium">Açık</span>
                    </div>

                    <!-- Tema Butonu -->
                    <button id="themeToggle" class="glass rounded-lg p-2 text-white hover:scale-110 transition-all duration-300">
                        <i class="fas fa-moon text-lg"></i>
                    </button>

                    <!-- Çıkış Butonu -->
                    <button 
                        onclick="leaveRoom()"
                        class="bg-red-500/20 hover:bg-red-500/30 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center space-x-2 border border-red-400/30"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Çıkış</span>
                    </button>
                </div>
            </div>

            <!-- Mobil Oda Bilgisi -->
            <div class="md:hidden pb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Oda Kodu</p>
                        <p class="text-white font-mono font-bold text-lg" id="mobileRoomCode">-----</p>
                        <p class="text-blue-100 text-sm mt-1">Kullanıcı: <span id="mobileUserName" class="text-white">-----</span></p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-2 text-white bg-white/20 rounded-lg px-3 py-2">
                            <i class="fas fa-users text-sm"></i>
                            <span class="font-semibold" id="mobileParticipantCount">0</span>
                        </div>
                        <div id="mobileConnectionStatus" class="flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2">
                            <i class="fas fa-wifi text-sm"></i>
                        </div>
                        <div id="mobileMicStatus" class="flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2">
                            <i class="fas fa-microphone text-sm"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Ana İçerik -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Video Grid -->
        <div id="videoGrid" class="video-layout">
            <!-- Videolar burada görünecek -->
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 mt-6">
            <!-- Sol Sidebar - Katılımcılar -->
            <div class="xl:col-span-1 participants-container">
                <div class="glass rounded-2xl p-6 h-full flex flex-col">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-user-friends mr-3 text-blue-200"></i>
                        Katılımcılar
                        <span class="ml-2 bg-white/20 text-white text-sm px-2 py-1 rounded-full" id="participantCountBadge">0</span>
                    </h2>
                    
                    <!-- Yazıyor İndikatörü -->
                    <div id="typingIndicator" class="hidden mb-3 p-2 bg-white/10 rounded-lg">
                        <div class="flex items-center text-blue-200 text-sm">
                            <span id="typingUsers" class="mr-2"></span>
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="participantsList" class="flex-1 space-y-3 overflow-y-auto custom-scrollbar">
                        <!-- Katılımcılar buraya eklenecek -->
                        <div class="text-center py-8">
                            <i class="fas fa-users text-2xl text-white/50 mb-3"></i>
                            <p class="text-blue-200 text-sm">Henüz katılımcı yok</p>
                        </div>
                    </div>

                    <!-- Bağlantı Bilgileri ve İstatistikler -->
                    <div class="mt-6 pt-4 border-t border-white/20">
                        <div class="space-y-3 text-xs">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Bağlantı Durumu:</span>
                                <span id="connectionInfo" class="text-green-200 flex items-center">
                                    <i class="fas fa-circle text-xs mr-1"></i>
                                    Stabil
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Ağ Gecikmesi:</span>
                                <span class="text-white" id="latencyInfo">~25ms</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Ses Kalitesi:</span>
                                <span class="text-white" id="audioQuality">HD</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Aktif Süre:</span>
                                <span class="text-white" id="activeDuration">00:00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Toplam Mesaj:</span>
                                <span class="text-white" id="totalMessages">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orta Alan - Sohbet ve Medya -->
            <div class="xl:col-span-2">
                <!-- Sohbet Kutusu -->
                <div class="glass rounded-2xl h-full flex flex-col">
                    <!-- Mesajlar -->
                    <div id="messages" class="flex-1 p-6 space-y-4 overflow-y-auto custom-scrollbar max-h-[500px] xl:max-h-[calc(100vh-300px)]">
                        <div class="text-center py-12">
                            <i class="fas fa-comments text-3xl text-white/50 mb-4"></i>
                            <p class="text-blue-200 text-lg font-semibold">Sohbet Başlatın</p>
                            <p class="text-blue-200 text-sm mt-2">Mesaj göndererek sohbeti başlatın</p>
                        </div>
                    </div>

                    <!-- Mesaj Gönderme -->
                    <div class="border-t border-white/20 p-6">
                        <div class="flex space-x-4">
                            <input 
                                type="text" 
                                id="messageInput"
                                placeholder="Mesajınızı yazın..."
                                class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-300"
                                oninput="handleTyping()"
                            >
                            <button 
                                onclick="sendMessage()"
                                class="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                id="sendMessageBtn"
                            >
                                <i class="fas fa-paper-plane"></i>
                                <span class="hidden sm:inline">Gönder</span>
                            </button>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <div class="text-blue-200 text-xs">
                                <i class="fas fa-info-circle mr-1"></i>
                                Enter tuşu ile gönderebilirsiniz
                            </div>
                            <div class="text-blue-200 text-xs">
                                <span id="charCount">0</span>/500
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Sidebar - Kontroller -->
            <div class="xl:col-span-1">
                <div class="space-y-6">
                    <!-- Ses Kontrolleri -->
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-microphone mr-3 text-green-200"></i>
                            Ses Kontrolleri
                        </h2>
                        
                        <div class="space-y-4">
                            <button 
                                id="micBtn"
                                onclick="toggleMic()"
                                class="w-full bg-green-500/20 hover:bg-green-500/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-green-400/30"
                            >
                                <i class="fas fa-microphone"></i>
                                <span>Mikrofonu Kapat</span>
                            </button>
                            
                            <!-- Ses Seviye Göstergesi -->
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-blue-200 text-sm">Ses Seviyesi</span>
                                    <span class="text-green-200 text-sm" id="audioStatus">%0</span>
                                </div>
                                <div class="audio-visualizer">
                                    <div id="audioLevel" class="audio-level" style="width: 0%"></div>
                                </div>
                                <div class="text-blue-200 text-xs mt-2 text-center">
                                    Gerçek zamanlı ses seviyesi
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Görüntü Kontrolleri -->
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-video mr-3 text-purple-200"></i>
                            Görüntü Kontrolleri
                        </h2>
                        
                        <div class="space-y-3">
                            <button 
                                id="cameraBtn"
                                onclick="toggleCamera()"
                                class="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20"
                            >
                                <i class="fas fa-video-slash"></i>
                                <span>Kamerayı Aç</span>
                            </button>

                            <button 
                                id="screenBtn"
                                onclick="toggleScreenShare()"
                                class="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20"
                            >
                                <i class="fas fa-desktop"></i>
                                <span>Ekran Paylaş</span>
                            </button>
                        </div>
                    </div>

                    <!-- Oda Bilgileri -->
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-info-circle mr-3 text-blue-200"></i>
                            Oda Bilgileri
                        </h2>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Oluşturulma:</span>
                                <span class="text-white" id="roomCreated">--:--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Oda Süresi:</span>
                                <span class="text-white" id="roomDuration">00:00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Oda Durumu:</span>
                                <span class="text-green-200 flex items-center">
                                    <i class="fas fa-circle text-xs mr-1"></i>
                                    Aktif
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Maks. Kullanıcı:</span>
                                <span class="text-white">10</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-200">Versiyon:</span>
                                <span class="text-white">Profesyonel</span>
                            </div>
                        </div>
                    </div>

                    <!-- Hızlı Erişim -->
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-bolt mr-3 text-yellow-200"></i>
                            Hızlı Erişim
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button 
                                onclick="copyRoomCode()"
                                class="bg-white/10 hover:bg-white/20 text-white py-2 px-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20 text-sm"
                            >
                                <i class="fas fa-copy"></i>
                                <span>Kodu Kopyala</span>
                            </button>
                            <button 
                                onclick="inviteUsers()"
                                class="bg-white/10 hover:bg-white/20 text-white py-2 px-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20 text-sm"
                            >
                                <i class="fas fa-share-alt"></i>
                                <span>Davet Et</span>
                            </button>
                            <button 
                                onclick="toggleFullscreen()"
                                class="bg-white/10 hover:bg-white/20 text-white py-2 px-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20 text-sm"
                            >
                                <i class="fas fa-expand"></i>
                                <span>Tam Ekran</span>
                            </button>
                            <button 
                                onclick="showShortcuts()"
                                class="bg-white/10 hover:bg-white/20 text-white py-2 px-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20 text-sm"
                            >
                                <i class="fas fa-keyboard"></i>
                                <span>Kısayollar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Değişkenler
        let roomStartTime = null;
        let typingTimer = null;
        let isTyping = false;
        let totalMessages = 0;
        let activeDuration = 0;

        // WebRTC Değişkenleri
        let localStream = null;
        let isAudioMuted = false;
        let isVideoEnabled = false;
        let isScreenSharing = false;
        let screenStream = null;
        let audioContext = null;
        let analyser = null;
        let audioLevelInterval = null;

        // Tam Ekran Değişkenleri
        let fullscreenVideoId = null;

        // WebRTC Bağlantıları
        let peerConnections = new Map();
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10,
            bundlePolicy: 'max-bundle',
            rtcpMuxPolicy: 'require'
        };

        // Tema değiştirme
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                html.classList.add('light');
                themeIcon.className = 'fas fa-moon text-lg';
                showNotification('Açık tema etkinleştirildi', 'success');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                themeIcon.className = 'fas fa-sun text-lg';
                showNotification('Koyu tema etkinleştirildi', 'success');
            }
        });

        // Socket.io bağlantısı
        const socket = io();

        // Bağlantı durumu takibi
        socket.on('connect', () => {
            updateConnectionStatus(true);
            showNotification('Sunucuya bağlandı', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            showNotification('Sunucu bağlantısı kesildi', 'error');
        });

        socket.on('reconnect', () => {
            updateConnectionStatus(true);
            showNotification('Sunucuya yeniden bağlandı', 'success');
        });

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('code');
            const userName = urlParams.get('name') || 'Kullanıcı-' + Math.floor(Math.random() * 1000);
            
            if (roomCode) {
                document.getElementById('currentRoomCode').textContent = roomCode;
                document.getElementById('mobileRoomCode').textContent = roomCode;
                document.getElementById('currentUserName').textContent = userName;
                document.getElementById('mobileUserName').textContent = userName;
                
                socket.emit('join-room', {
                    roomCode: roomCode,
                    userName: userName
                });
                
                startRoomTimer();
                startActiveDurationTimer();
                showNotification(`${roomCode} odasına hoş geldiniz!`, 'success');
                
                // Otomatik olarak mikrofonu başlat
                setTimeout(() => {
                    initializeMedia();
                }, 1000);
            } else {
                window.location.href = '/';
            }

            // Karakter sayacı
            document.getElementById('messageInput').addEventListener('input', function() {
                const charCount = this.value.length;
                document.getElementById('charCount').textContent = charCount;
                
                if (charCount > 500) {
                    this.value = this.value.substring(0, 500);
                    document.getElementById('charCount').textContent = 500;
                    showNotification('Mesaj 500 karakteri geçemez!', 'error');
                }
            });
        });

        // Medya başlatma
        async function initializeMedia() {
            try {
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1,
                            sampleRate: 48000,
                            sampleSize: 16
                        },
                        video: false
                    });
                    
                    startAudioLevelMonitor();
                    updateAudioButton();
                    updateGlobalMicStatus();
                    
                    showNotification('Mikrofon başlatıldı', 'success');
                }
            } catch (error) {
                console.error('Medya başlatma hatası:', error);
                showNotification('Mikrofon erişimi reddedildi', 'error');
            }
        }

        // TAM EKRAN FONKSİYONLARI
        function toggleVideoFullscreen(videoId) {
            const videoContainer = document.getElementById(`video-${videoId}`);
            
            if (!videoContainer) return;
            
            if (fullscreenVideoId === videoId) {
                exitVideoFullscreen();
            } else {
                enterVideoFullscreen(videoId);
            }
        }

        function enterVideoFullscreen(videoId) {
            const videoContainer = document.getElementById(`video-${videoId}`);
            const videoElement = document.getElementById(`video-element-${videoId}`);
            
            if (!videoContainer || !videoElement) return;
            
            if (fullscreenVideoId) {
                exitVideoFullscreen();
            }
            
            videoContainer.classList.add('video-fullscreen');
            videoElement.style.objectFit = 'contain';
            
            const controls = document.createElement('div');
            controls.className = 'fullscreen-controls';
            controls.innerHTML = `
                <button class="fullscreen-btn" onclick="exitVideoFullscreen()" title="Tam Ekrandan Çık">
                    <i class="fas fa-compress"></i>
                </button>
            `;
            videoContainer.appendChild(controls);
            
            fullscreenVideoId = videoId;
            
            document.addEventListener('keydown', handleFullscreenKeydown);
        }

        function exitVideoFullscreen() {
            if (!fullscreenVideoId) return;
            
            const videoContainer = document.getElementById(`video-${fullscreenVideoId}`);
            const videoElement = document.getElementById(`video-element-${fullscreenVideoId}`);
            
            if (videoContainer && videoElement) {
                videoContainer.classList.remove('video-fullscreen');
                videoElement.style.objectFit = 'cover';
                
                const controls = videoContainer.querySelector('.fullscreen-controls');
                if (controls) {
                    controls.remove();
                }
            }
            
            fullscreenVideoId = null;
            document.removeEventListener('keydown', handleFullscreenKeydown);
        }

        function handleFullscreenKeydown(event) {
            if (event.key === 'Escape' && fullscreenVideoId) {
                exitVideoFullscreen();
            }
        }

        // WEBRTC FONKSİYONLARI - GELİŞTİRİLMİŞ

        async function createPeerConnection(targetSocketId, userName) {
            console.log('Yeni WebRTC bağlantısı oluşturuluyor:', targetSocketId);
            
            const peerConnection = new RTCPeerConnection(rtcConfiguration);
            
            // Local stream'i ekle
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    console.log('Track ekleniyor:', track.kind, track.enabled);
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Remote stream geldiğinde
            peerConnection.ontrack = (event) => {
                console.log('Remote stream alındı:', targetSocketId, event.streams);
                const remoteStream = event.streams[0];
                if (remoteStream) {
                    createVideoElement(targetSocketId, remoteStream, false, userName);
                    
                    // Ses track'ini kontrol et ve muted durumunu ayarla
                    const audioTracks = remoteStream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        const audioElement = document.querySelector(`#video-element-${targetSocketId}`);
                        if (audioElement) {
                            audioElement.muted = false;
                        }
                    }
                }
            };
            
            // ICE candidate oluşturulduğunda
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        targetSocketId: targetSocketId,
                        candidate: event.candidate,
                        userName: document.getElementById('currentUserName').textContent
                    });
                }
            };
            
            // Bağlantı durumu değiştiğinde
            peerConnection.onconnectionstatechange = () => {
                console.log(`WebRTC bağlantı durumu (${targetSocketId}):`, peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    console.log(`WebRTC bağlantısı kuruldu: ${targetSocketId}`);
                } else if (peerConnection.connectionState === 'disconnected' || 
                          peerConnection.connectionState === 'failed') {
                    console.log(`WebRTC bağlantısı kesildi: ${targetSocketId}`);
                    cleanupPeerConnection(targetSocketId);
                }
            };
            
            peerConnections.set(targetSocketId, peerConnection);
            return peerConnection;
        }

        // Peer connection temizleme
        function cleanupPeerConnection(socketId) {
            const peerConnection = peerConnections.get(socketId);
            if (peerConnection) {
                peerConnection.close();
                peerConnections.delete(socketId);
            }
            
            const videoElement = document.getElementById(`video-${socketId}`);
            if (videoElement) {
                videoElement.remove();
            }
            
            const screenElement = document.getElementById(`video-${socketId}-screen`);
            if (screenElement) {
                screenElement.remove();
            }
        }

        // Offer oluştur ve gönder
        async function createAndSendOffer(targetSocketId, userName) {
            try {
                const peerConnection = await createPeerConnection(targetSocketId, userName);
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('webrtc-offer', {
                    targetSocketId: targetSocketId,
                    offer: offer,
                    userName: document.getElementById('currentUserName').textContent
                });
                
                console.log('WebRTC offer gönderildi:', targetSocketId);
            } catch (error) {
                console.error('Offer oluşturma hatası:', error);
            }
        }

        // Tüm peer connection'lara track'leri güncelle
        function updateTracksForAllPeers() {
            if (!localStream) return;
            
            peerConnections.forEach((peerConnection, socketId) => {
                const senders = peerConnection.getSenders();
                
                localStream.getTracks().forEach(track => {
                    const existingSender = senders.find(sender => 
                        sender.track && sender.track.kind === track.kind
                    );
                    
                    if (existingSender) {
                        existingSender.replaceTrack(track).catch(error => {
                            console.error('Track değiştirme hatası:', error);
                        });
                    } else {
                        peerConnection.addTrack(track, localStream);
                    }
                });
            });
        }

        // Mikrofon kontrolü
        async function toggleMic() {
            try {
                if (!localStream) {
                    await initializeMedia();
                    return;
                }
                
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    isAudioMuted = !isAudioMuted;
                    audioTracks[0].enabled = !isAudioMuted;
                    
                    // Tüm peer connection'lara ses durumunu güncelle
                    updateTracksForAllPeers();
                }
                
                updateAudioButton();
                updateGlobalMicStatus();
                
                socket.emit('audio-state-change', { 
                    isMuted: isAudioMuted,
                    userName: document.getElementById('currentUserName').textContent
                });
                
                showNotification(isAudioMuted ? 'Mikrofon kapatıldı' : 'Mikrofon açıldı', 'success');
                
            } catch (error) {
                console.error('Mikrofon kontrol hatası:', error);
                showNotification('Mikrofon kontrolü başarısız', 'error');
            }
        }

        // Kamera kontrolü
        async function toggleCamera() {
            try {
                if (isScreenSharing) {
                    showNotification('Ekran paylaşımı sırasında kamera açılamaz', 'error');
                    return;
                }
                
                if (!isVideoEnabled) {
                    const videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    });
                    
                    if (localStream) {
                        const videoTracks = localStream.getVideoTracks();
                        videoTracks.forEach(track => {
                            track.stop();
                            localStream.removeTrack(track);
                        });
                        
                        videoStream.getVideoTracks().forEach(track => {
                            localStream.addTrack(track);
                        });
                    } else {
                        localStream = videoStream;
                        await initializeMedia();
                    }
                    
                    createVideoElement(socket.id, localStream, true, 'Kamera');
                    isVideoEnabled = true;
                    
                    updateTracksForAllPeers();
                    
                    // Medya durumunu güncelle
                    socket.emit('media-status-update', {
                        userName: document.getElementById('currentUserName').textContent,
                        hasVideo: true,
                        hasAudio: !isAudioMuted,
                        isScreenSharing: false
                    });
                    
                } else {
                    const videoTracks = localStream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        videoTracks.forEach(track => {
                            track.stop();
                            localStream.removeTrack(track);
                        });
                    }
                    
                    const videoElement = document.getElementById(`video-${socket.id}`);
                    if (videoElement) {
                        videoElement.remove();
                    }
                    isVideoEnabled = false;
                    
                    updateTracksForAllPeers();
                    
                    // Medya durumunu güncelle
                    socket.emit('media-status-update', {
                        userName: document.getElementById('currentUserName').textContent,
                        hasVideo: false,
                        hasAudio: !isAudioMuted,
                        isScreenSharing: false
                    });
                }
                
                updateCameraButton();
                
            } catch (error) {
                console.error('Kamera kontrol hatası:', error);
                showNotification('Kamera erişimi başarısız', 'error');
            }
        }

        // Ekran paylaşımı - GELİŞTİRİLMİŞ
        async function toggleScreenShare() {
            try {
                if (isScreenSharing) {
                    // Ekran paylaşımını durdur
                    screenStream.getTracks().forEach(track => track.stop());
                    isScreenSharing = false;
                    screenStream = null;
                    
                    const screenElement = document.getElementById(`video-${socket.id}-screen`);
                    if (screenElement) {
                        screenElement.remove();
                    }
                    
                    // Orijinal kamerayı geri yükle
                    if (isVideoEnabled) {
                        await toggleCamera();
                        await toggleCamera();
                    }
                    
                    updateScreenShareButton();
                    
                    socket.emit('screen-share-stopped', {
                        userName: document.getElementById('currentUserName').textContent
                    });
                    
                    // Medya durumunu güncelle
                    socket.emit('media-status-update', {
                        userName: document.getElementById('currentUserName').textContent,
                        hasVideo: isVideoEnabled,
                        hasAudio: !isAudioMuted,
                        isScreenSharing: false
                    });
                    
                } else {
                    // Ekran paylaşımı başlat
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always'
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    isScreenSharing = true;
                    createVideoElement(socket.id + '-screen', screenStream, true, 'Ekran Paylaşımı');
                    
                    // Ekran paylaşımı track'larını peer connection'lara ekle
                    screenStream.getTracks().forEach(track => {
                        peerConnections.forEach(peerConnection => {
                            if (track.kind === 'video') {
                                const videoSender = peerConnection.getSenders().find(s => 
                                    s.track && s.track.kind === 'video'
                                );
                                if (videoSender) {
                                    videoSender.replaceTrack(track);
                                } else {
                                    peerConnection.addTrack(track, screenStream);
                                }
                            } else if (track.kind === 'audio') {
                                const audioSender = peerConnection.getSenders().find(s => 
                                    s.track && s.track.kind === 'audio'
                                );
                                if (audioSender) {
                                    audioSender.replaceTrack(track);
                                } else {
                                    peerConnection.addTrack(track, screenStream);
                                }
                            }
                        });
                        
                        track.onended = () => {
                            toggleScreenShare();
                        };
                    });
                    
                    updateScreenShareButton();
                    
                    socket.emit('screen-share-started', {
                        userName: document.getElementById('currentUserName').textContent
                    });
                    
                    // Medya durumunu güncelle
                    socket.emit('media-status-update', {
                        userName: document.getElementById('currentUserName').textContent,
                        hasVideo: false,
                        hasAudio: !isAudioMuted,
                        isScreenSharing: true
                    });
                }
            } catch (error) {
                console.error('Ekran paylaşımı hatası:', error);
                if (error.name !== 'NotAllowedError') {
                    showNotification('Ekran paylaşımı başarısız', 'error');
                }
            }
        }

        // Video elementi oluştur
        function createVideoElement(userId, stream, isLocal = false, title = '') {
            const videoGrid = document.getElementById('videoGrid');
            let videoContainer = document.getElementById(`video-${userId}`);
            
            if (!videoContainer) {
                videoContainer = document.createElement('div');
                videoContainer.id = `video-${userId}`;
                videoContainer.className = 'video-container';
                
                const videoElement = document.createElement('video');
                videoElement.id = `video-element-${userId}`;
                videoElement.className = 'video-element';
                videoElement.autoplay = true;
                videoElement.muted = isLocal;
                videoElement.playsInline = true;
                
                const overlay = document.createElement('div');
                overlay.className = 'video-overlay';
                overlay.innerHTML = `
                    <i class="fas ${isLocal ? 'fa-user' : 'fa-user-friends'} mr-1"></i>
                    ${title || (isLocal ? 'Siz' : 'Kullanıcı')}
                `;
                
                const audioIndicator = document.createElement('div');
                audioIndicator.className = `audio-indicator ${isLocal ? (isAudioMuted ? 'audio-muted' : 'audio-speaking') : 'audio-speaking'}`;
                audioIndicator.innerHTML = '<i class="fas fa-microphone text-xs text-white"></i>';
                
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.className = 'fullscreen-btn';
                fullscreenBtn.style.position = 'absolute';
                fullscreenBtn.style.top = '10px';
                fullscreenBtn.style.right = '40px';
                fullscreenBtn.style.zIndex = '10';
                fullscreenBtn.innerHTML = '<i class="fas fa-expand text-xs"></i>';
                fullscreenBtn.title = 'Tam Ekran';
                fullscreenBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleVideoFullscreen(userId);
                };
                
                videoContainer.appendChild(videoElement);
                videoContainer.appendChild(overlay);
                videoContainer.appendChild(audioIndicator);
                videoContainer.appendChild(fullscreenBtn);
                videoGrid.appendChild(videoContainer);
                
                // Video grid layout'ını güncelle
                updateVideoLayout();
            }
            
            const videoElement = document.getElementById(`video-element-${userId}`);
            if (videoElement) {
                videoElement.srcObject = stream;
                
                videoElement.onloadedmetadata = () => {
                    videoElement.play().catch(e => {
                        console.error('Video oynatma hatası:', e);
                    });
                };
            }
        }

        // Video grid layout'ını güncelle
        function updateVideoLayout() {
            const videoGrid = document.getElementById('videoGrid');
            const videoCount = videoGrid.children.length;
            
            videoGrid.className = 'video-layout';
            
            if (videoCount === 1) {
                videoGrid.classList.add('single');
            } else if (videoCount === 2) {
                videoGrid.classList.add('double');
            }
        }

        // SOCKET EVENT LISTENER'LARI

        // Odaya başarıyla katılma
        socket.on('room-joined', (data) => {
            console.log('Odaya katıldı:', data);
            updateParticipantList(data.participants);
            
            if (data.existingUsers && data.existingUsers.length > 0) {
                data.existingUsers.forEach(user => {
                    createAndSendOffer(user.socketId, user.userName);
                });
            }
        });

        // Yeni kullanıcı katıldı
        socket.on('new-user-joined', (data) => {
            console.log('Yeni kullanıcı katıldı:', data);
            createAndSendOffer(data.socketId, data.userName);
        });

        // WebRTC Offer alma
        socket.on('webrtc-offer', async (data) => {
            console.log('WebRTC offer alındı:', data.fromSocketId);
            try {
                const peerConnection = await createPeerConnection(data.fromSocketId, data.userName);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('webrtc-answer', {
                    targetSocketId: data.fromSocketId,
                    answer: answer,
                    userName: document.getElementById('currentUserName').textContent
                });
            } catch (error) {
                console.error('Offer işleme hatası:', error);
            }
        });

        // WebRTC Answer alma
        socket.on('webrtc-answer', async (data) => {
            console.log('WebRTC answer alındı:', data.fromSocketId);
            const peerConnection = peerConnections.get(data.fromSocketId);
            if (peerConnection) {
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                } catch (error) {
                    console.error('Answer işleme hatası:', error);
                }
            }
        });

        // WebRTC ICE Candidate alma
        socket.on('webrtc-ice-candidate', async (data) => {
            console.log('WebRTC ICE candidate alındı:', data.fromSocketId);
            const peerConnection = peerConnections.get(data.fromSocketId);
            if (peerConnection && peerConnection.remoteDescription) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    console.error('ICE candidate ekleme hatası:', error);
                }
            }
        });

        // Kullanıcı bağlantısı kesildi
        socket.on('user-disconnected', (data) => {
            console.log('Kullanıcı bağlantısı kesildi:', data.socketId);
            cleanupPeerConnection(data.socketId);
            updateVideoLayout();
        });

        // Kullanıcı ayrılma
        socket.on('user-left', (data) => {
            cleanupPeerConnection(data.socketId);
            updateVideoLayout();
        });

        // Mesaj alma
        socket.on('receive-message', (data) => {
            if (data.type === 'system') {
                addMessageToChat(data.userName, data.message, data.timestamp, false, true);
            } else {
                if (data.userName !== document.getElementById('currentUserName').textContent) {
                    addMessageToChat(data.userName, data.message, data.timestamp, false, false);
                    totalMessages++;
                    document.getElementById('totalMessages').textContent = totalMessages;
                }
            }
        });

        // Katılımcı listesi güncelleme
        socket.on('update-participants', (participants) => {
            updateParticipantList(participants);
        });

        // Kullanıcı katılma
        socket.on('user-joined', (data) => {
            // Sistem mesajı otomatik olarak gönderilecek
        });

        // Yazıyor indikatörü
        socket.on('user-typing-start', (data) => {
            const typingIndicator = document.getElementById('typingIndicator');
            const typingUsers = document.getElementById('typingUsers');
            
            typingIndicator.classList.remove('hidden');
            typingUsers.textContent = `${data.userName} yazıyor...`;
        });

        socket.on('user-typing-stop', () => {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.classList.add('hidden');
        });

        // Ses durumu değişikliği
        socket.on('audio-state-changed', (data) => {
            updateParticipantAudioStatus(data.userId, data.isMuted);
            
            const audioIndicator = document.querySelector(`#video-${data.userId} .audio-indicator`);
            if (audioIndicator) {
                if (data.isMuted) {
                    audioIndicator.className = 'audio-indicator audio-muted';
                } else {
                    audioIndicator.className = 'audio-indicator audio-speaking';
                }
            }
        });

        // Ekran paylaşımı durumu
        socket.on('user-screen-sharing', (data) => {
            if (!data.isSharing) {
                const screenElement = document.getElementById(`video-${data.socketId}-screen`);
                if (screenElement) {
                    screenElement.remove();
                    updateVideoLayout();
                }
            }
        });

        // Medya durumu güncelleme
        socket.on('user-media-updated', (data) => {
            // Medya durumu değişiklikleri için işlemler
            console.log('Medya durumu güncellendi:', data);
        });

        // Ses seviyesi monitörü
        function startAudioLevelMonitor() {
            if (!localStream) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                audioLevelInterval = setInterval(() => {
                    if (!localStream) {
                        document.getElementById('audioLevel').style.width = '0%';
                        document.getElementById('audioStatus').textContent = '%0';
                        return;
                    }
                    
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    let average = sum / bufferLength;
                    let level = Math.min(average / 128 * 100, 100);
                    
                    if (!isAudioMuted) {
                        document.getElementById('audioLevel').style.width = level + '%';
                        document.getElementById('audioStatus').textContent = '%' + Math.round(level);
                    } else {
                        document.getElementById('audioLevel').style.width = '0%';
                        document.getElementById('audioStatus').textContent = '%0';
                    }
                }, 100);
            } catch (error) {
                console.error('Ses seviyesi monitörü hatası:', error);
            }
        }

        // Ses butonunu güncelle
        function updateAudioButton() {
            const micBtn = document.getElementById('micBtn');
            const icon = micBtn.querySelector('i');
            const text = micBtn.querySelector('span');
            
            if (isAudioMuted) {
                icon.className = 'fas fa-microphone-slash';
                text.textContent = 'Mikrofonu Aç';
                micBtn.className = 'w-full bg-red-500/20 hover:bg-red-500/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-red-400/30';
            } else {
                icon.className = 'fas fa-microphone';
                text.textContent = 'Mikrofonu Kapat';
                micBtn.className = 'w-full bg-green-500/20 hover:bg-green-500/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-green-400/30';
            }
        }

        // Global mikrofon durumunu güncelle
        function updateGlobalMicStatus() {
            const globalStatus = document.getElementById('globalMicStatus');
            const mobileStatus = document.getElementById('mobileMicStatus');
            const globalIcon = globalStatus?.querySelector('i');
            const mobileIcon = mobileStatus?.querySelector('i');
            const globalText = globalStatus?.querySelector('span');
            
            if (isAudioMuted) {
                if (globalStatus) {
                    globalStatus.className = 'hidden sm:flex items-center space-x-2 text-red-200 bg-red-500/20 rounded-lg px-3 py-2';
                    globalIcon.className = 'fas fa-microphone-slash text-sm';
                    globalText.textContent = 'Sessiz';
                }
                if (mobileStatus) {
                    mobileStatus.className = 'flex items-center space-x-2 text-red-200 bg-red-500/20 rounded-lg px-3 py-2';
                    mobileIcon.className = 'fas fa-microphone-slash text-sm';
                }
            } else {
                if (globalStatus) {
                    globalStatus.className = 'hidden sm:flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2';
                    globalIcon.className = 'fas fa-microphone text-sm';
                    globalText.textContent = 'Açık';
                }
                if (mobileStatus) {
                    mobileStatus.className = 'flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2';
                    mobileIcon.className = 'fas fa-microphone text-sm';
                }
            }
        }

        // Kamera butonunu güncelle
        function updateCameraButton() {
            const cameraBtn = document.getElementById('cameraBtn');
            const icon = cameraBtn.querySelector('i');
            const text = cameraBtn.querySelector('span');
            
            if (isVideoEnabled) {
                icon.className = 'fas fa-video';
                text.textContent = 'Kamerayı Kapat';
                cameraBtn.className = 'w-full bg-green-500/20 hover:bg-green-500/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-green-400/30';
            } else {
                icon.className = 'fas fa-video-slash';
                text.textContent = 'Kamerayı Aç';
                cameraBtn.className = 'w-full bg-white/20 hover:bg-white/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20';
            }
        }

        // Ekran paylaşım butonunu güncelle
        function updateScreenShareButton() {
            const screenBtn = document.getElementById('screenBtn');
            const icon = screenBtn.querySelector('i');
            const text = screenBtn.querySelector('span');
            
            if (isScreenSharing) {
                icon.className = 'fas fa-stop';
                text.textContent = 'Paylaşımı Durdur';
                screenBtn.className = 'w-full bg-red-500/20 hover:bg-red-500/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-red-400/30';
            } else {
                icon.className = 'fas fa-desktop';
                text.textContent = 'Ekran Paylaş';
                screenBtn.className = 'w-full bg-white/20 hover:bg-white/30 text-white py-3 px-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-2 border border-white/20';
            }
        }

        // Mesaj gönderme
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message === '') return;
            
            const userName = document.getElementById('currentUserName').textContent;
            const timestamp = new Date().toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            addMessageToChat(userName, message, timestamp, true);
            
            socket.emit('send-message', {
                userName: userName,
                message: message,
                timestamp: timestamp
            });
            
            messageInput.value = '';
            document.getElementById('charCount').textContent = '0';
            
            clearTyping();
            
            totalMessages++;
            document.getElementById('totalMessages').textContent = totalMessages;
        }

        // Mesajı sohbete ekle
        function addMessageToChat(userName, message, timestamp, isOwn = false, isSystem = false) {
            const messagesContainer = document.getElementById('messages');
            
            const emptyState = messagesContainer.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageElement = document.createElement('div');
            
            if (isSystem) {
                messageElement.className = 'system-message';
                let icon = 'fa-info-circle';
                if (message.includes('katıldı')) icon = 'fa-user-plus';
                else if (message.includes('ayrıldı')) icon = 'fa-user-minus';
                else if (message.includes('mikrofon')) icon = 'fa-microphone';
                else if (message.includes('kamera')) icon = 'fa-video';
                else if (message.includes('ekran')) icon = 'fa-desktop';
                
                messageElement.innerHTML = `
                    <div class="text-blue-200 text-sm italic">
                        <i class="fas ${icon} mr-1"></i>
                        <span>${message}</span>
                        <span class="text-xs ml-2 opacity-70">${timestamp}</span>
                    </div>
                `;
            } else {
                messageElement.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
                messageElement.innerHTML = `
                    <div class="max-w-xs lg:max-w-md ${isOwn ? 'bg-blue-500/20' : 'bg-white/10'} rounded-2xl p-4 backdrop-blur-sm border ${isOwn ? 'border-blue-400/30' : 'border-white/20'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-semibold text-white text-sm">${isOwn ? 'Siz' : userName}</span>
                            <span class="text-blue-200 text-xs">${timestamp}</span>
                        </div>
                        <p class="text-white text-sm">${message}</p>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Yazıyor durumu
        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing-start', {
                    userName: document.getElementById('currentUserName').textContent
                });
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                isTyping = false;
                socket.emit('typing-stop', {
                    userName: document.getElementById('currentUserName').textContent
                });
            }, 1000);
        }

        // Yazıyor durumunu temizle
        function clearTyping() {
            isTyping = false;
            socket.emit('typing-stop', {
                userName: document.getElementById('currentUserName').textContent
            });
        }

        // Bağlantı durumunu güncelle
        function updateConnectionStatus(isConnected) {
            const connectionStatus = document.getElementById('connectionStatus');
            const mobileConnectionStatus = document.getElementById('mobileConnectionStatus');
            
            if (isConnected) {
                if (connectionStatus) {
                    connectionStatus.className = 'hidden sm:flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2';
                    connectionStatus.querySelector('i').className = 'fas fa-wifi text-sm';
                    connectionStatus.querySelector('span').textContent = 'Bağlı';
                }
                if (mobileConnectionStatus) {
                    mobileConnectionStatus.className = 'flex items-center space-x-2 text-green-200 bg-green-500/20 rounded-lg px-3 py-2';
                    mobileConnectionStatus.querySelector('i').className = 'fas fa-wifi text-sm';
                }
            } else {
                if (connectionStatus) {
                    connectionStatus.className = 'hidden sm:flex items-center space-x-2 text-red-200 bg-red-500/20 rounded-lg px-3 py-2';
                    connectionStatus.querySelector('i').className = 'fas fa-wifi text-sm';
                    connectionStatus.querySelector('span').textContent = 'Bağlantı Yok';
                }
                if (mobileConnectionStatus) {
                    mobileConnectionStatus.className = 'flex items-center space-x-2 text-red-200 bg-red-500/20 rounded-lg px-3 py-2';
                    mobileConnectionStatus.querySelector('i').className = 'fas fa-wifi text-sm';
                }
            }
        }

        // Oda süresi
        function startRoomTimer() {
            roomStartTime = new Date();
            
            setInterval(() => {
                if (roomStartTime) {
                    const now = new Date();
                    const diff = Math.floor((now - roomStartTime) / 1000);
                    const minutes = Math.floor(diff / 60);
                    const seconds = diff % 60;
                    
                    document.getElementById('roomDuration').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Aktif süre
        function startActiveDurationTimer() {
            setInterval(() => {
                activeDuration++;
                const minutes = Math.floor(activeDuration / 60);
                const seconds = activeDuration % 60;
                document.getElementById('activeDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Bildirim göster
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            notification.className = notification.className.replace(/bg-(red|green|blue|yellow)-500\/20/g, '');
            
            let icon = 'fa-info-circle';
            if (type === 'success') {
                notification.classList.add('bg-green-500/20', 'border-green-400/30');
                icon = 'fa-check-circle';
            } else if (type === 'error') {
                notification.classList.add('bg-red-500/20', 'border-red-400/30');
                icon = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-500/20', 'border-yellow-400/30');
                icon = 'fa-exclamation-triangle';
            } else {
                notification.classList.add('bg-blue-500/20', 'border-blue-400/30');
            }
            
            notification.querySelector('i').className = `fas ${icon} mr-3 text-lg`;
            
            notification.classList.remove('hidden', 'opacity-0', 'translate-y-2');
            notification.classList.add('flex', 'opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // Oda bilgilerini güncelle
        function updateRoomInfo() {
            const now = new Date();
            document.getElementById('roomCreated').textContent = now.toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Katılımcı listesini güncelle
        function updateParticipantList(participants) {
            const participantsList = document.getElementById('participantsList');
            const participantCount = participants.length;
            
            document.getElementById('participantCount').textContent = participantCount;
            document.getElementById('mobileParticipantCount').textContent = participantCount;
            document.getElementById('participantCountBadge').textContent = participantCount;
            
            if (participantCount === 0) {
                participantsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-users text-2xl text-white/50 mb-3"></i>
                        <p class="text-blue-200 text-sm">Henüz katılımcı yok</p>
                    </div>
                `;
                return;
            }
            
            participantsList.innerHTML = '';
            participants.forEach(participant => {
                const participantElement = document.createElement('div');
                participantElement.className = `flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/10 participant-item ${participant.isMuted ? 'participant-muted' : ''}`;
                participantElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                            ${participant.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="text-white font-medium text-sm">${participant.name}</p>
                            <p class="text-blue-200 text-xs">${participant.isMuted ? 'Sessiz' : 'Konuşuyor'}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas ${participant.isMuted ? 'fa-microphone-slash text-red-400' : 'fa-microphone text-green-400'} text-sm"></i>
                    </div>
                `;
                participantsList.appendChild(participantElement);
            });
        }

        // Katılımcı ses durumunu güncelle
        function updateParticipantAudioStatus(userId, isMuted) {
            const participantItems = document.querySelectorAll('.participant-item');
            participantItems.forEach(item => {
                const userNameElement = item.querySelector('.text-white');
                if (userNameElement) {
                    const participantElement = item;
                    const icon = item.querySelector('.fa-microphone, .fa-microphone-slash');
                    const statusText = item.querySelector('.text-blue-200');
                    
                    if (isMuted) {
                        participantElement.classList.add('participant-muted');
                        icon.className = 'fas fa-microphone-slash text-red-400 text-sm';
                        statusText.textContent = 'Sessiz';
                    } else {
                        participantElement.classList.remove('participant-muted');
                        icon.className = 'fas fa-microphone text-green-400 text-sm';
                        statusText.textContent = 'Konuşuyor';
                    }
                }
            });
        }

        // Yardımcı fonksiyonlar
        function copyRoomCode() {
            const roomCode = document.getElementById('currentRoomCode').textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                showNotification('Oda kodu panoya kopyalandı', 'success');
            });
        }

        function inviteUsers() {
            const roomCode = document.getElementById('currentRoomCode').textContent;
            const inviteText = `SyncVibe profesyonel sohbet odasına katılın! Oda kodu: ${roomCode}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'SyncVibe Davet',
                    text: inviteText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(inviteText).then(() => {
                    showNotification('Davet metni panoya kopyalandı', 'success');
                });
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Tam ekran hatası:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function showShortcuts() {
            showNotification('Kısayollar: Enter - Mesaj gönder, ESC - Tam ekrandan çık', 'info');
        }

        function leaveRoom() {
            if (confirm('Odadan ayrılmak istediğinizden emin misiniz?')) {
                if (fullscreenVideoId) {
                    exitVideoFullscreen();
                }
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                }
                if (audioLevelInterval) {
                    clearInterval(audioLevelInterval);
                }
                
                peerConnections.forEach(pc => pc.close());
                peerConnections.clear();
                
                socket.disconnect();
                window.location.href = '/';
            }
        }

        // Enter tuşu ile mesaj gönderme
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Sayfa kapatma/kullanıcı ayrılma
        window.addEventListener('beforeunload', function() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            if (audioLevelInterval) {
                clearInterval(audioLevelInterval);
            }
            
            peerConnections.forEach(pc => pc.close());
            socket.disconnect();
        });

        // Başlangıçta oda bilgilerini güncelle
        updateRoomInfo();
    </script>
</body>
</html>